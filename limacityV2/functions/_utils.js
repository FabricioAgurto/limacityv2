export async function hashPassword(password){const e=new TextEncoder(),t=crypto.getRandomValues(new Uint8Array(16)),r=await crypto.subtle.importKey("raw",e.encode(password),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),a=await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:150000,hash:"SHA-256"},r,{name:"HMAC",hash:"SHA-256",length:256},!0,["sign","verify"]),n=await crypto.subtle.exportKey("raw",a),o=btoa(String.fromCharCode(...t)),s=btoa(String.fromCharCode(...new Uint8Array(n)));return`pbkdf2$${o}$${s}`}export async function verifyPassword(e,t){const[r,a,n]=t.split("$"),o=new TextEncoder(),s=Uint8Array.from(atob(a),e=>e.charCodeAt(0)),i=Uint8Array.from(atob(n),e=>e.charCodeAt(0)),c=await crypto.subtle.importKey("raw",o.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),u=await crypto.subtle.deriveKey({name:"PBKDF2",salt:s,iterations:150000,hash:"SHA-256"},c,{name:"HMAC",hash:"SHA-256",length:256},!0,["sign","verify"]),d=new Uint8Array(await crypto.subtle.exportKey("raw",u));if(d.length!==i.length)return!1;let l=0;for(let e=0;e<d.length;e++)l|=d[e]^i[e];return 0===l}function b64url(e){const t=btoa(String.fromCharCode(...new Uint8Array(e)));return t.replaceAll("=","").replaceAll("+","-").replaceAll("/","_")}function enc(e){return btoa(JSON.stringify(e)).replaceAll("=","").replaceAll("+","-").replaceAll("/","_")}export async function signJWT(e,t,r=900){const a={alg:"HS256",typ:"JWT"},n=Math.floor(Date.now()/1e3),o=n+r,s={...e,iss:t.JWT_ISSUER,aud:t.JWT_AUDIENCE,iat:n,exp:o},i=`${enc(a)}.${enc(s)}`,c=await crypto.subtle.importKey("raw",new TextEncoder().encode(t.JWT_SECRET),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),u=await crypto.subtle.sign("HMAC",c,new TextEncoder().encode(i));return`${i}.${b64url(u)}`}export async function verifyJWT(e,t){try{const[r,a,n]=e.split("."),o=await crypto.subtle.importKey("raw",new TextEncoder().encode(t.JWT_SECRET),{name:"HMAC",hash:"SHA-256"},!1,["verify"]),s=await crypto.subtle.verify("HMAC",o,new TextEncoder().encode(`${r}.${a}`),Uint8Array.from(atob(n.replaceAll("-","+").replaceAll("_","/")),e=>e.charCodeAt(0)));if(!s)return null;const i=JSON.parse(atob(a.replaceAll("-","+").replaceAll("_","/")));return i.exp<Math.floor(Date.now()/1e3)?null:i}catch{return null}}export async function getUserRolesAndPerms(e,t){const r=await e.prepare(`
    SELECT r.name as role FROM user_roles ur
    JOIN roles r ON r.id = ur.role_id
    WHERE ur.user_id=?1
  `).bind(t).all(),a=r.results.map(e=>e.role),n=await e.prepare(`
    SELECT p.key as perm FROM role_permissions rp
    JOIN permissions p ON p.id = rp.permission_id
    WHERE rp.role_id IN (SELECT role_id FROM user_roles WHERE user_id=?1)
  `).bind(t).all(),o=n.results.map(e=>e.perm);return{roleNames:a,permKeys:o}}export function json(e,t,r=200){return new Response(JSON.stringify(t),{status:r,headers:{"Content-Type":"application/json"}})}